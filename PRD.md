# PhotoWatermark 项目产品需求文档

## 1. 项目概述

PhotoWatermark 是一个基于 Java 的命令行程序，用于自动为图片添加基于拍摄日期的水印。该程序将读取图片的 EXIF 信息中的拍摄时间，提取年月日作为水印文本，并根据用户设定的字体大小、颜色和位置，将水印绘制到图片上，最终保存为新的图片文件。

## 2. 功能需求

### 2.1 核心功能
- **图片路径处理**：接收用户输入的图片文件路径
- **EXIF 信息读取**：读取指定路径下所有图片的 EXIF 信息，提取拍摄时间（年月日）
- **水印添加**：将提取的拍摄日期作为文本水印添加到图片上
- **自定义水印设置**：支持用户设置水印的字体大小、颜色和位置
- **图片保存**：将添加水印后的图片保存到新的目录

### 2.2 辅助功能
- **错误处理**：对无效图片文件、无法读取 EXIF 信息的情况进行适当处理
- **日志输出**：显示处理进度和结果信息
- **目录创建**：自动创建保存水印图片的目录

## 3. 技术要求

- 编程语言：Java 8 或更高版本
- 图片处理库：使用 Java ImageIO 或第三方库（如 Apache Commons Imaging）处理图片和 EXIF 信息
- 命令行参数解析：使用标准 Java 参数解析或第三方库（如 Apache Commons CLI）

## 4. 输入输出规格

### 4.1 输入
- **图片文件路径**：用户提供的图片文件路径（支持绝对路径和相对路径）
- **水印字体大小**：可选参数，默认值可设为 30
- **水印颜色**：可选参数，默认值可设为白色或黑色
- **水印位置**：可选参数，默认值可设为右下角

### 4.2 输出
- **处理后的图片**：保存在原目录的 `_watermark` 子目录中，文件名保持不变
- **控制台输出**：处理状态、成功/失败信息

## 5. 命令行界面设计

程序通过命令行参数接收用户输入，基本格式如下：

```
java -jar PhotoWatermark.jar <图片路径> [选项]
```

### 5.1 参数说明
- `<图片路径>`：必需参数，指定要处理的图片文件或目录路径
- `--size, -s`：可选参数，指定水印字体大小（默认值：30）
- `--color, -c`：可选参数，指定水印颜色（默认值：white）
- `--position, -p`：可选参数，指定水印位置（默认值：bottom-right）
- `--help, -h`：显示帮助信息

### 5.2 位置选项
位置参数支持以下值：
- `top-left`：左上角
- `top-center`：上居中
- `top-right`：右上角
- `center-left`：左居中
- `center`：正中央
- `center-right`：右居中
- `bottom-left`：左下角
- `bottom-center`：下居中
- `bottom-right`：右下角

### 5.3 颜色选项
颜色参数支持以下值：
- `black`：黑色
- `white`：白色
- `red`：红色
- `blue`：蓝色
- `green`：绿色
- 也可支持十六进制颜色码，如 `#FF0000` 表示红色

## 6. 项目结构

```
PhotoWatermark/
├── src/
│   └── main/
│       ├── java/
│       │   └── com/
│       │       └── photowatermark/
│       │           ├── App.java                 # 程序入口
│       │           ├── model/
│       │           │   ├── WatermarkConfig.java  # 水印配置类
│       │           │   └── ImageInfo.java        # 图片信息类
│       │           ├── service/
│       │           │   ├── ImageProcessor.java   # 图片处理服务
│       │           │   └── ExifReader.java       # EXIF信息读取服务
│       │           ├── util/
│       │           │   ├── FileUtil.java         # 文件处理工具
│       │           │   └── CommandLineParser.java # 命令行参数解析工具
│       │           └── exception/
│       │               ├── ImageProcessException.java  # 图片处理异常
│       │               └── ExifReadException.java     # EXIF读取异常
│       └── resources/
│           └── log4j2.xml                        # 日志配置文件
├── pom.xml                                       # Maven项目配置
└── README.md                                     # 项目说明文档
```

## 7. 实现细节

### 7.1 图片处理流程
1. 解析命令行参数，获取图片路径和水印配置
2. 检查并验证输入路径
3. 遍历路径下的所有图片文件
4. 对每个图片文件：
   a. 读取 EXIF 信息，提取拍摄日期
   b. 如果无法读取拍摄日期，使用当前日期或跳过该图片
   c. 创建水印图片
   d. 保存处理后的图片到目标目录
5. 输出处理结果统计信息

### 7.2 EXIF 信息读取
使用 Apache Commons Imaging 库读取图片的 EXIF 信息，特别是 `DateTimeOriginal` 字段。如果该字段不存在，则尝试读取 `DateTime` 或 `DateTimeDigitized` 字段。

### 7.3 水印绘制
使用 Java 的 Graphics2D API 在图片上绘制文本水印。水印文本将采用提取的拍摄日期，格式为 "YYYY-MM-DD"。

### 7.4 错误处理
- 对于无法读取的图片文件，记录错误日志并继续处理其他文件
- 对于没有 EXIF 信息的图片，提供默认处理策略（如跳过或使用当前日期）
- 对于保存失败的情况，提供明确的错误信息

## 8. 测试需求

### 8.1 功能测试
- 测试不同格式的图片文件（JPEG, PNG 等）
- 测试具有完整 EXIF 信息的图片
- 测试没有 EXIF 信息或 EXIF 信息不完整的图片
- 测试各种水印位置和颜色组合

### 8.2 边界测试
- 测试大尺寸图片的处理性能
- 测试批量处理多个图片的情况
- 测试无效的文件路径和文件名

### 8.3 兼容性测试
- 确保程序在不同版本的 Java 环境下正常运行
- 确保处理后的图片在不同的图片查看器中正确显示

## 9. 部署说明

将程序打包为可执行的 JAR 文件，用户可直接通过命令行运行。JAR 文件应包含所有必要的依赖库。

## 10. 后续优化建议

- 添加批量处理多个目录的功能
- 支持自定义水印文本（不仅限于拍摄日期）
- 添加水印透明度调整功能
- 支持图片压缩和格式转换功能
- 开发图形用户界面（GUI）版本